# Dokploy Configuration for ABSA UNIVERSITY LMS
# Deploy in Hostinger VPS using Dokploy

app:
  name: absa-university
  description: ABSA UNIVERSITY - Learning Management System
  
services:
  - name: absa-lms
    type: docker
    dockerfile: Dockerfile
    
    # Port configuration
    ports:
      - "8082:8082"
    
    # Environment variables - Use ${} syntax for Dokploy
    environment:
      # Node environment
      NODE_ENV: production
      
      # Database connection
      DATABASE_URL: mysql://${DB_USER}:${DB_PASSWORD}@${DB_HOST}:${DB_PORT}/${DB_NAME}
      
      # JWT and authentication
      JWT_SECRET: ${JWT_SECRET}
      OAUTH_SERVER_URL: ${OAUTH_SERVER_URL}
      VITE_OAUTH_PORTAL_URL: ${VITE_OAUTH_PORTAL_URL}
      VITE_APP_ID: ${VITE_APP_ID}
      
      # Application branding
      VITE_APP_TITLE: ${VITE_APP_TITLE:-ABSA UNIVERSITY}
      VITE_APP_LOGO: ${VITE_APP_LOGO:-/logo-absa.png}
      
      # Owner information
      OWNER_NAME: ${OWNER_NAME}
      OWNER_OPEN_ID: ${OWNER_OPEN_ID}
      
      # API endpoints
      BUILT_IN_FORGE_API_URL: ${BUILT_IN_FORGE_API_URL}
      BUILT_IN_FORGE_API_KEY: ${BUILT_IN_FORGE_API_KEY}
      VITE_FRONTEND_FORGE_API_URL: ${VITE_FRONTEND_FORGE_API_URL}
      VITE_FRONTEND_FORGE_API_KEY: ${VITE_FRONTEND_FORGE_API_KEY}
      
      # Analytics (optional)
      VITE_ANALYTICS_ENDPOINT: ${VITE_ANALYTICS_ENDPOINT:-}
      VITE_ANALYTICS_WEBSITE_ID: ${VITE_ANALYTICS_WEBSITE_ID:-}
    
    # Health check
    healthCheck:
      enabled: true
      path: /
      interval: 30
      timeout: 10
      retries: 3
      startPeriod: 40
    
    # Resource limits
    resources:
      cpus: "1"
      memory: "1024M"
    
    # Restart policy
    restart: always
    
    # Volumes for persistent data
    volumes:
      - absa-data:/app/data

volumes:
  absa-data:
    driver: local

# Database service (optional - use external MySQL if available)
# If you have a managed MySQL database on Hostinger, skip this and use DATABASE_URL
# database:
#   name: absa-mysql
#   type: mysql
#   version: "8.0"
#   environment:
#     MYSQL_ROOT_PASSWORD: ${DB_ROOT_PASSWORD}
#     MYSQL_DATABASE: ${DB_NAME}
#     MYSQL_USER: ${DB_USER}
#     MYSQL_PASSWORD: ${DB_PASSWORD}
#   ports:
#     - "3306:3306"
#   volumes:
#     - mysql-data:/var/lib/mysql

# Reverse proxy / SSL configuration
# Dokploy will handle SSL automatically if configured
ingress:
  - domain: ${APP_DOMAIN}
    port: 8082
    ssl: true  # Enable SSL/HTTPS

# Deployment hooks
hooks:
  beforeStart:
    - echo "Starting ABSA UNIVERSITY LMS..."
  afterStart:
    - echo "ABSA UNIVERSITY LMS started successfully"
  beforeStop:
    - echo "Stopping ABSA UNIVERSITY LMS..."
